#!/bin/sh

PERMTYPE=`echo M | sed -e 's/\(.\).*/\1/' | tr a-z A-Z`

if [ "x`whoami`" = xroot ]
then
	if test "x$PERMTYPE" = x -o "x$PERMTYPE" = xM
	then
		CATUSER=greg
		CATGROUP=gopher
	elif test "x$PERMTYPE" = xG
	then
		CATUSER=greg
		CATGROUP=gopher
	else
		CATUSER=greg
		CATGROUP=gopher
	fi
fi

if test "x$PERMTYPE" = x -o "x$PERMTYPE" = xM -o "x$PERMTYPE" = xG
then
	DMODE=2770
	FMODE=660
else
	DMODE=700
	FMODE=600
fi

# Link the image directory always
ln -s /home/greg/www/bw/images /home/greg/catalogs/bw

# Make log directories to store logs.
if test -n ''
then 
	LOGDIR=''
	mkdir -p     $LOGDIR/logs
	mkdir -p     $LOGDIR/orders
	touch        $LOGDIR/error.log
	ln    -s     $LOGDIR/error.log /home/greg/catalogs/bw
	ln    -s     $LOGDIR/logs      /home/greg/catalogs/bw
	ln    -s     $LOGDIR/orders    /home/greg/catalogs/bw
	chmod $DMODE $LOGDIR/logs
	chmod $DMODE $LOGDIR/orders
	touch        $LOGDIR/error.log
	if test -n "$CATUSER"
	then
		[ -n "$CATUSER"  ] && chown $CATUSER  $LOGDIR/error.log
		[ -n "$CATGROUP" ] && chgrp $CATGROUP $LOGDIR/error.log
	fi
else
	LOGDIR='/home/greg/catalogs/bw'
	mkdir -p     $LOGDIR/orders
	mkdir -p     $LOGDIR/logs
	chmod $DMODE $LOGDIR/logs
	chmod $DMODE $LOGDIR/orders
	touch        $LOGDIR/error.log
	if test -n "$CATUSER"
	then
		[ -n "$CATUSER"  ] && chown $CATUSER  $LOGDIR/error.log
		[ -n "$CATGROUP" ] && chgrp $CATGROUP $LOGDIR/error.log
	fi
fi

chmod $FMODE $LOGDIR/error.log
chmod $FMODE /home/greg/catalogs/bw/catalog.cfg

# Make cache directories to store tmps.
if test -n ''
then 
	CACHEDIR=''
	mkdir -p $CACHEDIR/session
	ln    -s $CACHEDIR/session /home/greg/catalogs/bw
	mkdir -p $CACHEDIR/tmp
	ln    -s $CACHEDIR/tmp     /home/greg/catalogs/bw
else
	CACHEDIR='/home/greg/catalogs/bw'
	mkdir -p     $CACHEDIR/session
	mkdir -p     $CACHEDIR/tmp
	chmod $DMODE $CACHEDIR/session
	chmod $DMODE $CACHEDIR/tmp
fi

# Fix directory ownership if running as root
if test -n "$CATUSER"
then
	for i in $LOGDIR/logs $LOGDIR/orders $CACHEDIR/session $CACHEDIR/tmp
	do
		[ -n "$CATUSER"  ] && chown $CATUSER $i
		[ -n "$CATGROUP" ] && chgrp $CATGROUP $i
	done
fi
